---
title: "meta_plots"
author: "Yihan Wang"
date: "2025-09-16"
output: word_document
---

```{r}
rm(list=ls())
set.seed(42)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(stringr)
library(scales)
```

```{r}
source("medication-lmer-utility.R")
source("plots.R")
```

```{r}
med_cols<-c("ACEi","ARB","BetaBlk","CCB","Diuretic","Statin","Metformin")
med_cols_rename <-c("ACEi","ARBs","β-Blocker","CCBs","Diuretics","Statins","Metformin")
```

```{r}
NACC_full_df_cdr_imputed<-read.csv("../preprocessed_data/NACC/NACC_cdr_imputed_binary.csv")
AIBL_full_df_cdr_imputed<-read.csv("../preprocessed_data/AIBL/AIBL_cdr_imputed_binary.csv")
HABS_full_df_cdr_imputed<-read.csv("../preprocessed_data/HABSHD/HABSHD_cdr_imputed_binary.csv")
```

```{r}
colnames(NACC_full_df_cdr_imputed)[colnames(NACC_full_df_cdr_imputed) %in% med_cols] <- med_cols_rename
colnames(AIBL_full_df_cdr_imputed)[colnames(AIBL_full_df_cdr_imputed) %in% med_cols] <- med_cols_rename
colnames(HABS_full_df_cdr_imputed)[colnames(HABS_full_df_cdr_imputed) %in% med_cols] <- med_cols_rename
```

################## Baseline medicaton#############
```{r}
AIBL_full_df_cdr_imputed_baseline <- make_participant_summary(
  df            = AIBL_full_df_cdr_imputed,
  id_col        = "id",
  time_col      = "months_since_baseline",
  visit_col     = "visit_no",   # or NULL if absent
  dataset_col   = NULL,         # <- optional
  value_col     = "CDR",
  out_col       = "dCDR_per_year",
  med_cols      = med_cols_rename,
  demo_cols     = c("age","sex","APOE4","status"),
  collapse_mode = "baseline"
)

NACC_full_df_cdr_imputed_baseline <- make_participant_summary(
  df            = NACC_full_df_cdr_imputed,
  id_col        = "id",
  time_col      = "months_since_baseline",
  visit_col     = "visit_no",   # or NULL if absent
  dataset_col   = NULL,         # <- optional
  value_col     = "CDR",
  out_col       = "dCDR_per_year",
  med_cols      = med_cols_rename,
  demo_cols     = c("age","sex","APOE4","status"),
  collapse_mode = "baseline"
)

HABS_full_df_cdr_imputed_baseline <- make_participant_summary(
  df            = HABS_full_df_cdr_imputed,
  id_col        = "id",
  time_col      = "months_since_baseline",
  visit_col     = "visit_no",   # or NULL if absent
  dataset_col   = NULL,         # <- optional
  value_col     = "CDR",
  out_col       = "dCDR_per_year",
  med_cols      = med_cols_rename,
  demo_cols     = c("age","sex","APOE4","status"),
  collapse_mode = "baseline"
)
```

Medication exposure proportions at Baseline
Composite ‘Any medication’ = participant has ≥1 of the meds
```{r}
res3 <- baseline_props_to_pdf(
  NACC_df = NACC_full_df_cdr_imputed_baseline,
  AIBL_df = AIBL_full_df_cdr_imputed_baseline,
  HABS_df = HABS_full_df_cdr_imputed_baseline,
  med_cols = med_cols_rename,
  out_pdf = "../plots/drug_usage/CDR_baseline_drug_usage.pdf",
  width = 11, height = 5,     # absolute inches
  fill_values = c("Yes" = "#67a8cd", "No" = "#E68B81"),
  add_borders = TRUE,
  text_size = 12                 # smaller overall text
)
```

```{r}
baseline_table2 <- baseline_props_table(
  NACC_df = NACC_full_df_cdr_imputed_baseline,
  AIBL_df = AIBL_full_df_cdr_imputed_baseline,
  HABS_df = HABS_full_df_cdr_imputed_baseline,
  dataset_order = c("NACC","AIBL","HABS"),
  include_individual_meds = TRUE,
  include_any_med = TRUE,
  med_cols = med_cols_rename,
  digits = 1
)
print(baseline_table2)
```


################## Overall medicaton#############
```{r}
AIBL_full_df_cdr_imputed_overall <- make_participant_summary(
  df            = AIBL_full_df_cdr_imputed,
  id_col        = "id",
  time_col      = "months_since_baseline",
  visit_col     = "visit_no",   # or NULL if absent
  dataset_col   = NULL,         # <- optional
  value_col     = "CDR",
  out_col       = "dCDR_per_year",
  med_cols      = med_cols_rename,
  demo_cols     = c("age","sex","APOE4","status"),
  collapse_mode = "overall"
)

NACC_full_df_cdr_imputed_overall <- make_participant_summary(
  df            = NACC_full_df_cdr_imputed,
  id_col        = "id",
  time_col      = "months_since_baseline",
  visit_col     = "visit_no",   # or NULL if absent
  dataset_col   = NULL,         # <- optional
  value_col     = "CDR",
  out_col       = "dCDR_per_year",
  med_cols      = med_cols_rename,
  demo_cols     = c("age","sex","APOE4","status"),
  collapse_mode = "overall"
)

HABS_full_df_cdr_imputed_overall <- make_participant_summary(
  df            = HABS_full_df_cdr_imputed,
  id_col        = "id",
  time_col      = "months_since_baseline",
  visit_col     = "visit_no",   # or NULL if absent
  dataset_col   = NULL,         # <- optional
  value_col     = "CDR",
  out_col       = "dCDR_per_year",
  med_cols      = med_cols_rename,
  demo_cols     = c("age","sex","APOE4","status"),
  collapse_mode = "overall"
)
```

```{r}
res4 <- baseline_props_to_pdf(
  NACC_df = NACC_full_df_cdr_imputed_overall,
  AIBL_df = AIBL_full_df_cdr_imputed_overall,
  HABS_df = HABS_full_df_cdr_imputed_overall,
  med_cols = med_cols_rename,
  out_pdf = "../plots/drug_usage/CDR_overall_drug_usage.pdf",
  width = 11, height = 5,     # absolute inches
  fill_values = c("Yes" = "#67a8cd", "No" = "#E68B81"),
  add_borders = TRUE,
  text_size = 12                  # smaller overall text
)
```

```{r}
overall_table2 <- baseline_props_table(
  NACC_df = NACC_full_df_cdr_imputed_overall,
  AIBL_df = AIBL_full_df_cdr_imputed_overall,
  HABS_df = HABS_full_df_cdr_imputed_overall,
  dataset_order = c("NACC", "AIBL","HABS-HD"),
  med_cols = med_cols_rename,
  include_individual_meds = TRUE,
  include_any_med = TRUE,
  digits = 1
)
print(overall_table2)
```

