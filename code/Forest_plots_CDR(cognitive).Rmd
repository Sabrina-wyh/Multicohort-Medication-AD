---
title: "meta_plots"
author: "Yihan Wang"
date: "2025-09-16"
output: word_document
---

```{r}
rm(list=ls())
library(missRanger)
library(dplyr)
library(lubridate)
library(lme4)       # mixed models
library(lmerTest)   # p-values for lmer
library(splines)
library(conflicted)
library(broom.mixed)
library(dplyr)
library(stringr)
library(forcats)
library(ggplot2)
library(forestploter)
library(grid)
library(gridtext)
conflicts_prefer(dplyr::lag)
conflicts_prefer(lmerTest::lmer)
conflicts_prefer(dplyr::filter)
```

```{r}
source("medication-lmer-utility.R")
source("plots.R")
```

```{r}
NACC_full_df_cdr<-read.csv("../preprocessed_data/NACC/NACC_cdr_imputed.csv")
AIBL_full_df_cdr<-read.csv("../preprocessed_data/AIBL/AIBL_cdr_imputed.csv")
HABS_full_df_cdr<-read.csv("../preprocessed_data/HABSHD/HABSHD_cdr_imputed.csv")
NACC_full_df_cdr$edu <- scale(NACC_full_df_cdr$edu)
NACC_full_df_cdr$age <- scale(NACC_full_df_cdr$age)
AIBL_full_df_cdr$edu <- scale(AIBL_full_df_cdr$edu)
AIBL_full_df_cdr$age <- scale(AIBL_full_df_cdr$age)
HABS_full_df_cdr$edu <- scale(HABS_full_df_cdr$edu)
HABS_full_df_cdr$age <- scale(HABS_full_df_cdr$age)
```

```{r}
NACC_hc= split_by_baseline(NACC_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$HC
AIBL_hc= split_by_baseline(AIBL_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$HC
HABS_hc= split_by_baseline(HABS_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$HC
```


### CU
```{r}
NACC_hc$visit_date <- as.Date(NACC_hc$visit_date, format = "%Y-%m-%d")
fit_NACC_CU <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = NACC_hc
)
summary(fit_NACC_CU)
```


```{r}
AIBL_hc$visit_date <- as.Date(AIBL_hc$visit_date, format = "%Y-%m-%d")
fit_AIBL_CU <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = AIBL_hc
)
summary(fit_AIBL_CU)
```

```{r}
HABS_hc$visit_date <- as.Date(HABS_hc$visit_date, format = "%Y-%m-%d")
fit_HABS_CU <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = HABS_hc
)
summary(fit_HABS_CU)
```

# MCI
```{r}
NACC_mci= split_by_baseline(NACC_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$MCI
AIBL_mci= split_by_baseline(AIBL_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$MCI
HABS_mci= split_by_baseline(HABS_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$MCI
```

```{r}
NACC_mci$visit_date <- as.Date(NACC_mci$visit_date, format = "%Y-%m-%d")
fit_NACC_MCI <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = NACC_mci
)
summary(fit_NACC_MCI)
```

```{r}
AIBL_mci$visit_date <- as.Date(AIBL_mci$visit_date, format = "%Y-%m-%d")
fit_AIBL_MCI <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = AIBL_mci
)
summary(fit_AIBL_MCI)
```


```{r}
HABS_mci$visit_date <- as.Date(HABS_mci$visit_date, format = "%Y-%m-%d")
fit_HABS_MCI <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = HABS_mci
)
summary(fit_HABS_MCI)
```


# AD
```{r}
NACC_ad= split_by_baseline(NACC_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$AD
AIBL_ad= split_by_baseline(AIBL_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$AD
HABS_ad= split_by_baseline(HABS_full_df_cdr, id_col = "id", visit_col = "visit_no", status_col = "status")$AD
```

```{r}
NACC_ad$visit_date <- as.Date(NACC_ad$visit_date, format = "%Y-%m-%d")
fit_NACC_AD <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = NACC_ad
)
summary(fit_NACC_AD)
```

```{r}
AIBL_ad$visit_date <- as.Date(AIBL_ad$visit_date, format = "%Y-%m-%d")
fit_AIBL_AD <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = AIBL_ad
)
summary(fit_AIBL_AD)
```


```{r}
HABS_ad$visit_date <- as.Date(HABS_ad$visit_date, format = "%Y-%m-%d")
fit_HABS_AD <- lmer(
  CDR ~ year_since_baseline +
    age + sex + edu + APOE4 +
    ACEi + ARB + BetaBlk + CCB + Diuretic + Metformin + Statin + 
    ACEi:year_since_baseline + ARB:year_since_baseline + BetaBlk:year_since_baseline +
    CCB:year_since_baseline + Diuretic:year_since_baseline + 
    Metformin:year_since_baseline + Statin:year_since_baseline +
    (1 + year_since_baseline | id),
  data = HABS_ad
)
summary(fit_HABS_AD)
```



# plots
```{r}
terms_all <-c(
    "year_since_baseline","age","sex","edu","APOE4",
    "ACEiTrue","ARBTrue","BetaBlkTrue","CCBTrue",
    "DiureticTrue","MetforminTrue", "StatinTrue",
    "year_since_baseline:ACEiTrue","year_since_baseline:ARBTrue",
    "year_since_baseline:BetaBlkTrue","year_since_baseline:CCBTrue",
    "year_since_baseline:DiureticTrue", "year_since_baseline:MetforminTrue",
    "year_since_baseline:StatinTrue"
  )
terms_rename <- c(
    "year_since_baseline"="Time",
    "age"="Age (baseline)",
    "sex"="Sex (ref: Female)",
    "edu"="Education (z-scored)",
    "APOE4"="APOE4 carrier (ref: Yes)",
    "ACEiTrue"="ACEi",
    "ARBTrue"="ARB",
    "BetaBlkTrue"="BetaBlk",
    "CCBTrue"="CCB",
    "DiureticTrue"="Diuretic",
    "MetforminTrue"="Metformin",
    "StatinTrue"="Statin",
    "year_since_baseline:ACEiTrue"="ACEi × Time",
    "year_since_baseline:ARBTrue"="ARB × Time",
    "year_since_baseline:BetaBlkTrue"="BetaBlk × Time",
    "year_since_baseline:CCBTrue"="CCB × Time",
    "year_since_baseline:DiureticTrue"="Diuretic × Time",
    "year_since_baseline:MetforminTrue"="Metformin × Time",
    "year_since_baseline:StatinTrue"="Statin × Time"
  )
```


```{r}
plot_forest_subset(
  fits = list(
    CU     = list(fit_NACC_CU,   fit_AIBL_CU,   fit_HABS_CU),
    MCI   = list(fit_NACC_MCI,   fit_AIBL_MCI,   fit_HABS_MCI),
    AD     = list(fit_NACC_AD,   fit_AIBL_AD,   fit_HABS_AD)
  ),
  terms        = terms_all,
  groups       = c("CU","MCI","AD"),
  cohorts      = c("NACC","AIBL","HABS"),
  term_labels  = terms_rename,
  title        = "",
  filename     = "../plots/forestplot/CDR_forestplot_cognition.pdf",
  width        = 15,
  height       = 20,

  # layout / styling
  ref_line     = 0,
  xlim_fixed   = c(-1.8, 1.8),
  cohort_colors = c("#DAA87C", "#92A5D1", "#C9DCC4"),
  cohort_shapes = c(15, 16, 18),
  point_size   = 0.8,
  line_width   = 2.5,
  row_padding_mm = 10,

  # spacing between big columns (group blocks)
  gutter       = TRUE,
  gutter_width = 0.04,

  # column widths (feel free to tweak these three)
  first_col_width = 0.40,   # "Measurements" column
  est_frac        = 0.22,   # Estimate(SE) column (per group)
  ci_frac         = 0.16    # CI/forest column (per group)
)

```

