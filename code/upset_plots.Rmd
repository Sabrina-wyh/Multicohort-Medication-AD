---
title: "meta_plots"
author: "Yihan Wang"
date: "2025-09-16"
output: word_document
---

```{r}
rm(list=ls())
set.seed(42)
library(missRanger)
library(tidyverse)
library(ggplot2)
library(UpSetR)
library(purrr)
conflicts_prefer(UpSetR::upset)
```

```{r}
source("medication-lmer-utility.R")
source("plots.R")
```

```{r}
med_cols <- c("ACEi","ARB","BetaBlk","CCB","Diuretic","Metformin","Statin")
med_cols_rename <-c("ACEi","ARBs","Î²-Blocker","CCBs","Diuretics","Statins","Metformin")
```

################## Meta Analysis - Overall ##################



### CDR - baseline
```{r}
meta_df_cdr <- read.csv("../preprocessed_data/meta/meta_cdr_upset.csv")
colnames(meta_df_cdr)[colnames(meta_df_cdr) %in% med_cols] <- med_cols_rename

```

```{r}
baseline_meta_df_cdr <- select_baseline(meta_df_cdr, c(med_cols_rename, c('id', 'dataset')))
cairo_pdf(file="../plots/upsetplot/meta_baseline_cdr_upset.pdf", onefile=FALSE)
upset(baseline_meta_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      queries = list(
        list(query = elements,
             params = list("dataset", c("NACC", "AIBL","HABS")), color = "#DAA87C", active = T, query.name = "NACC"),
        list(query = elements,
             params = list("dataset", c("AIBL","HABS")), color = "#92A5D1", active = T, query.name = "AIBL"),
        list(query = elements,
             params = list("dataset", "HABS"), color = "#C9DCC4", active = T, query.name = "HABS-HD")),
      query.legend = "bottom",
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3,
      text.scale = c(1.1, 1, 1, 1, 1.2, 1))
dev.off()
```

### CDR - acrosslifetime
```{r}
overall_meta_df_cdr <- collapse_longitudinal(meta_df_cdr, med_cols_rename)
cairo_pdf(file="../plots/upsetplot/meta_overall_cdr_upset.pdf", onefile=FALSE)
upset(overall_meta_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      queries = list(
        list(query = elements,
             params = list("dataset", c("NACC", "AIBL","HABS")), color = "#DAA87C", active = T, query.name = "NACC"),
        list(query = elements,
             params = list("dataset", c("AIBL","HABS")), color = "#92A5D1", active = T, query.name = "AIBL"),
        list(query = elements,
             params = list("dataset", "HABS"), color = "#C9DCC4", active = T, query.name = "HABS-HD")),
      query.legend = "bottom",
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```

################## AIBL ##################
### CDR - baseline
```{r}
baseline_AIBL_df_cdr <- baseline_meta_df_cdr[baseline_meta_df_cdr$dataset=="AIBL",]
cairo_pdf(file="../plots/upsetplot/AIBL_baseline_cdr_upset.pdf", onefile=FALSE)
upset(baseline_AIBL_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```

### CDR - acrosslifetime
```{r}
overall_AIBL_df_cdr <- overall_meta_df_cdr[overall_meta_df_cdr$dataset=="AIBL",]
cairo_pdf(file="../plots/upsetplot/AIBL_overall_cdr_upset.pdf", onefile=FALSE)
upset(overall_AIBL_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```
################## NACC ##################
### CDR - baseline
```{r}
baseline_NACC_df_cdr <- baseline_meta_df_cdr[baseline_meta_df_cdr$dataset=="NACC",]
cairo_pdf(file="../plots/upsetplot/NACC_baseline_cdr_upset.pdf", onefile=FALSE)
upset(baseline_NACC_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```

### CDR - acrosslifetime
```{r}
overall_NACC_df_cdr <- overall_meta_df_cdr[overall_meta_df_cdr$dataset=="NACC",]
cairo_pdf(file="../plots/upsetplot/NACC_overall_cdr_upset.pdf", onefile=FALSE)
upset(overall_NACC_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```

################## HABS ##################
### CDR - baseline
```{r}
baseline_HABS_df_cdr <- baseline_meta_df_cdr[baseline_meta_df_cdr$dataset=="HABS",]
cairo_pdf(file="../plots/upsetplot/HABS_baseline_cdr_upset.pdf", onefile=FALSE)
upset(baseline_HABS_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```

### CDR - acrosslifetime
```{r}
overall_HABS_df_cdr <- overall_meta_df_cdr[overall_meta_df_cdr$dataset=="HABS",]
cairo_pdf(file="../plots/upsetplot/HABS_overall_cdr_upset.pdf", onefile=FALSE)
upset(overall_HABS_df_cdr, sets= rev(med_cols_rename), 
      # keep.order = TRUE,
      nintersects = 30, 
      order.by = "freq",
      empty.intersections = "on",
      mb.ratio=c(0.65,0.35), point.size=1, line.size=0.3)
dev.off()
```